<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UMM BOM DOLCE — POS</title>
  <!-- Montserrat (encabezado) -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#d8c3a5">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <style>
    :root{
      --sand:#E3D5A3;
      --light:#f3f3f3;
      --muted:#444;
      --bg:#f8f8f6;
      --panel-width:760px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      font-family: 'Montserrat', Arial, sans-serif;
      color:#222;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:18px;
    }
    .app{
      width:100%;
      max-width:var(--panel-width);
    }
    header{
      text-align:center;
      margin-bottom:12px;
    }
    header h1{
      margin:0;
      font-size:34px;
      letter-spacing:1px;
    }
    .panel{
      background:var(--sand);
      padding:16px;
      border-radius:14px;
      border:1px solid #e1d6b7;
    }
    label{display:block;margin-top:10px;font-size:0.95rem}
    input[type=text],input[type=number]{width:100%;padding:10px;border-radius:8px;border:1px solid #e9e6df;margin-top:6px;font-size:1rem}
    .row{display:flex;gap:8px}
    .row .col{flex:1}
    .inline-total{margin-top:8px;font-weight:700;text-align:right}
    .btn-inline{display:inline-block;margin:6px 6px 0 0;padding:8px 10px;border-radius:8px;background:var(--sand);border:0;font-weight:700;cursor:pointer}
    .payment-methods{display:flex;justify-content:space-around;margin-top:12px}
    .button-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:14px}
    .action-button{
      background:var(--sand);
      border:0;padding:12px;border-radius:26px;font-weight:700;font-size:1.05rem;cursor:pointer;box-shadow:none;
    }
    .action-button:active{box-shadow:0 6px 12px rgba(0,0,0,0.18);transform:scale(0.99);background:#d8d3c5}
    #preview{margin-top:14px}
    .receipt{background:#fff;padding:14px;border-radius:8px;border:1px solid #e8e4da;font-family:'Courier New',monospace}
    .receipt h2{text-align:center;margin:0 0 8px 0;font-family:Montserrat, sans-serif}
    .small{font-size:0.92rem;color:var(--muted)}
    .controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px;border-radius:8px;cursor:pointer}
    details{margin-top:8px}
    summary{font-weight:700;cursor:pointer;padding:6px 8px;border-radius:8px;background:#fafafa;border:1px solid #eee}
    .list-item{padding:8px 0;border-bottom:1px dashed #eee}
    @media(max-width:820px){
      .button-grid{grid-template-columns:1fr 1fr}
      .row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>UMM BOM DOLCE</h1>
    </header>
    <main class="panel" role="main" aria-label="Punto de venta">
      <!-- Formulario de ingreso -->
      <label for="cliente">Nombre del cliente</label>
      <input id="cliente" type="text" placeholder="Nombre del cliente">
      <label for="producto">Producto</label>
      <input id="producto" type="text" placeholder="Ej: Quesillo">
      <div class="row">
        <div class="col">
          <label for="cantidad">Cantidad</label>
          <input id="cantidad" type="number" min="1" value="1">
        </div>
        <div style="width:170px">
          <label for="valor">Valor unitario (COP)</label>
          <input id="valor" type="number" min="0" value="0">
        </div>
      </div>
      <div class="inline-total small" id="liveTotal">Total estimado: $0 COP</div>
      <!-- borrar campos antes de métodos de pago -->
      <div style="margin-top:10px">
        <button id="btnBorrarCampos" class="btn-inline">Borrar campos</button>
      </div>
      <div class="payment-methods" role="radiogroup" aria-label="Método de pago">
        <label><input type="radio" name="pago" value="Efectivo"> Efectivo</label>
        <label><input type="radio" name="pago" value="Nequi"> Nequi</label>
        <label><input type="radio" name="pago" value="Fiado"> Fiado</label>
      </div>
      <div class="button-grid" aria-hidden="false">
        <button class="action-button" id="btnGenerar">Generar recibo</button>
        <button class="action-button" id="btnHistorial">Historial</button>
        <button class="action-button" id="btnResumen">Resumen</button>
        <button class="action-button" id="btnDeuda">Deuda</button>
        <button class="action-button" id="btnRecordatorio">Recordatorio de deuda</button>
      </div>
      <div id="preview"></div>
    </main>
  </div>
  <!-- html2canvas para generación de imágenes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
  /* -----------------------------
     KEYS & UTILITIES
     -----------------------------*/
  const TZ = 'America/Caracas';
  const SALES_KEY = 'ummbd_sales_v1';
  const COUNTER_KEY = 'ummbd_counter_v1';
  function loadSales(){ return JSON.parse(localStorage.getItem(SALES_KEY) || '[]'); }
  function saveSales(arr){ localStorage.setItem(SALES_KEY, JSON.stringify(arr)); }
  let counter = parseInt(localStorage.getItem(COUNTER_KEY) || '1', 10);
  function nextReference(){
    const yy = new Date().toLocaleDateString('es-VE',{timeZone:TZ,year:'2-digit'});
    const ref = `UBD-${yy}-${String(counter).padStart(4,'0')}`;
    counter++;
    localStorage.setItem(COUNTER_KEY, String(counter));
    return ref;
  }
  function formatMoney(n){
    return new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}).format(Math.round(n));
  }
  function weekdayAbbrev(date){
    const map = {0:'Dom',1:'Lun',2:'Mar',3:'Mie',4:'Jue',5:'Vie',6:'Sab'};
    return map[(date.getDay())];
  }
  /* -----------------------------
     UI REFS
     -----------------------------*/
  const clienteEl = document.getElementById('cliente');
  const productoEl = document.getElementById('producto');
  const cantidadEl = document.getElementById('cantidad');
  const valorEl = document.getElementById('valor');
  const liveTotalEl = document.getElementById('liveTotal');
  const previewEl = document.getElementById('preview');
  const btnBorrarCampos = document.getElementById('btnBorrarCampos');
  const btnGenerar = document.getElementById('btnGenerar');
  const btnHistorial = document.getElementById('btnHistorial');
  const btnResumen = document.getElementById('btnResumen');
  const btnDeuda = document.getElementById('btnDeuda');
  const btnRecordatorio = document.getElementById('btnRecordatorio');
  /* -----------------------------
     LIVE TOTAL (previsualización mientras se escribe)
     -----------------------------*/
  function updateLiveTotal(){
    const q = parseInt(cantidadEl.value || '0',10);
    const v = parseFloat(valorEl.value || '0');
    const tot = (isNaN(q)||isNaN(v)) ? 0 : q * v;
    liveTotalEl.textContent = 'Total estimado: ' + formatMoney(tot) + ' COP';
  }
  cantidadEl.addEventListener('input', updateLiveTotal);
  valorEl.addEventListener('input', updateLiveTotal);
  updateLiveTotal();
  /* -----------------------------
     BORRAR CAMPOS
     -----------------------------*/
  btnBorrarCampos.addEventListener('click', ()=>{
    clienteEl.value = '';
    productoEl.value = '';
    cantidadEl.value = 1;
    valorEl.value = 0;
    updateLiveTotal();
    document.querySelectorAll('input[name="pago"]').forEach(r=>r.checked=false);
  });
  /* -----------------------------
     GENERAR RECIBO (guardar y previsualizar)
     -----------------------------*/
  btnGenerar.addEventListener('click', ()=>{
    const cliente = clienteEl.value.trim();
    const producto = productoEl.value.trim();
    const cantidad = parseInt(cantidadEl.value || '0',10);
    const valor = parseFloat(valorEl.value || '0');
    const metodoEl = document.querySelector('input[name="pago"]:checked');
    if(!cliente || !producto || !cantidad || !valor || !metodoEl){
      alert('Completa todos los campos y selecciona método de pago.');
      return;
    }
    const metodo = metodoEl.value;
    const total = cantidad * valor;
    const now = new Date();
    const weekday = weekdayAbbrev(now);
    const fechaLocal = now.toLocaleDateString('es-VE',{timeZone:TZ});
    const horaLocal = now.toLocaleTimeString('es-VE',{timeZone:TZ});
    const fechaHoraDisplay = `${weekday} ${fechaLocal} ${horaLocal}`;
    const referencia = nextReference();
    const sale = {
      referencia, cliente, producto, cantidad, valor, total,
      metodo, estado: metodo === 'Fiado' ? 'Pendiente' : 'Pagado',
      fechaISO: now.toISOString(), fechaDisplay: fechaHoraDisplay
    };
    // save
    const arr = loadSales();
    arr.unshift(sale);
    saveSales(arr);
    // show preview
    showReceiptPreview(sale, {showShare:true, showImage:true});
    // clear inputs after generating as requested
    clienteEl.value=''; productoEl.value=''; cantidadEl.value=1; valorEl.value=0; updateLiveTotal();
    document.querySelectorAll('input[name="pago"]').forEach(r=>r.checked=false);
  });
  /* showReceiptPreview: renders a receipt in preview area
     options:
       showShare: boolean -> whether to show "Compartir WhatsApp" button (optional)
       showImage: boolean -> whether to show "Generar imagen liviana" button
  */
  function showReceiptPreview(sale, options={showShare:true, showImage:true}){
    previewEl.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'receipt';
    box.id = 'receipt-'+sale.referencia;
    box.innerHTML = `
      <h2>UMM BOM DOLCE</h2>
      <p><strong>Referencia:</strong> ${sale.referencia}</p>
      <p><strong>Fecha:</strong> ${sale.fechaDisplay}</p>
      <hr>
      <p><strong>Cliente:</strong> ${sale.cliente}</p>
      <p><strong>Producto:</strong> ${sale.producto}</p>
      <p><strong>Cantidad:</strong> ${sale.cantidad}</p>
      <p><strong>Valor unitario:</strong> ${formatMoney(sale.valor)}</p>
      <p style="font-size:1.05rem;font-weight:700;"><strong>Total: ${formatMoney(sale.total)}</strong></p>
      <p><strong>Método:</strong> ${sale.metodo} — <em>${sale.estado}</em></p>
      <p style="text-align:center;margin-top:10px;">¡Gracias por su compra!</p>
    `;
    // controls container
    const controls = document.createElement('div');
    controls.className = 'controls-row';
    if(options.showShare){
      const shareBtn = document.createElement('button');
      shareBtn.className = 'btn-inline';
      shareBtn.textContent = 'Compartir por WhatsApp';
      shareBtn.onclick = ()=> shareReceiptText(sale);
      controls.appendChild(shareBtn);
    }
    if(options.showImage){
      const imgBtn = document.createElement('button');
      imgBtn.className = 'btn-inline';
      imgBtn.textContent = 'Generar imagen liviana';
      imgBtn.onclick = ()=> generateImageAndShare(sale, box);
      controls.appendChild(imgBtn);
    }
    box.appendChild(controls);
    previewEl.appendChild(box);
  }
  /* shareReceiptText: open whatsapp with textual message (optional) */
  function shareReceiptText(sale){
    const text = `Recibo ${sale.referencia}%0AUMM BOM DOLCE%0ACliente: ${encodeURIComponent(sale.cliente)}%0AProducto: ${encodeURIComponent(sale.producto)} x ${sale.cantidad}%0AValor unitario: ${formatMoney(sale.valor)}%0ATotal: ${formatMoney(sale.total)}%0AEstado: ${sale.estado}%0AMétodo: ${sale.metodo}`;
    const url = `https://wa.me/?text=${text}`;
    window.open(url,'_blank');
  }
  /**
   * generateImageAndShare(sale, node, presetText)
   * - sale: sale object
   * - node: DOM node representing the receipt (will be cloned and cleaned)
   * - presetText: optional string to include in WhatsApp share (URL encoded is handled)
   *
   * If presetText is provided, the fallback wa.me will include it.
   * For recordatorio de deuda we will pass the fixed message.
   */
  async function generateImageAndShare(sale, node, presetText = null){
    // clone node to a clean node with only receipt content (no controls)
    const clone = node.cloneNode(true);
    // remove controls (buttons) if any
    clone.querySelectorAll('.controls-row').forEach(el=>el.remove());
    // ensure white background for canvas
    clone.style.background = '#fff';
    clone.style.padding = '14px';
    // attach temporarily to body off-screen for rendering
    clone.style.position = 'fixed';
    clone.style.left = '-9999px';
    document.body.appendChild(clone);
    try{
      const canvas = await html2canvas(clone, {scale:1, backgroundColor:'#ffffff'});
      // convert to blob
      const blob = await new Promise(res => canvas.toBlob(res,'image/png'));
      const fileName = `${sale.referencia}.png`;
      const file = new File([blob], fileName, {type:'image/png'});
      // try navigator.share with files (mobile)
      if(navigator.canShare && navigator.canShare({files:[file]})){
        // if presetText provided, include it in the share text
        const shareData = {files:[file], text: presetText ? presetText : `Recibo ${sale.referencia}`};
        await navigator.share(shareData);
        // done
      } else {
        // fallback: open image in new tab and open whatsapp web with text
        const url = URL.createObjectURL(blob);
        const w = window.open('', '_blank');
        if(w){
          const img = w.document.createElement('img');
          img.src = url;
          img.style.maxWidth = '100%';
          w.document.body.style.margin = '0';
          w.document.body.appendChild(img);
          const a = w.document.createElement('a');
          a.href = url; a.download = fileName; a.textContent = 'Descargar imagen'; a.style.display='block'; a.style.margin='10px';
          w.document.body.appendChild(a);
        }
        // open whatsapp with pre-filled text to help user
        // if presetText given, use it; otherwise use default record text
        const pre = presetText ? presetText : `Recordatorio - Recibo ${sale.referencia}%0AUMM BOM DOLCE%0ACliente: ${encodeURIComponent(sale.cliente)}%0AProducto: ${encodeURIComponent(sale.producto)} x ${sale.cantidad}%0ATotal: ${formatMoney(sale.total)}`;
        const wa = `https://wa.me/?text=${encodeURIComponent(pre)}`;
        setTimeout(()=> window.open(wa,'_blank'), 500);
      }
    } catch(e){
      console.error('Error al generar imagen:', e);
      alert('No fue posible generar la imagen.');
    } finally {
      // cleanup
      document.body.removeChild(clone);
    }
  }
  /* -----------------------------
     HISTORIAL (con buscador por cliente y borrar todo con confirm)
     -----------------------------*/
  btnHistorial.addEventListener('click', ()=>{
    const sales = loadSales();
    previewEl.innerHTML = '';
    const box = document.createElement('div');
    box.className = 'receipt';
    box.innerHTML = `<h2>Historial de ventas</h2>
      <div style="margin-top:8px;">
        <input id="histSearch" type="text" placeholder="Buscar por nombre de cliente" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e9e6df">
        <div style="display:flex;justify-content:space-between;margin-top:8px">
          <div class="small">${sales.length} recibos</div>
          <div><button id="btnClearAll" class="ghost">Borrar historial</button></div>
        </div>
        <div id="histList" style="margin-top:10px;max-height:360px;overflow:auto"></div>
      </div>`;
    previewEl.appendChild(box);
    const histList = document.getElementById('histList');
    const search = document.getElementById('histSearch');
    function renderHist(filter=''){
      const arr = loadSales().filter(s => s.cliente.toLowerCase().includes(filter.toLowerCase()));
      if(arr.length===0){ histList.innerHTML = '<div class="small">Sin recibos</div>'; return; }
      histList.innerHTML = arr.map(s => `
        <div class="list-item">
          <div><strong>${s.referencia}</strong> — ${s.fechaDisplay}</div>
          <div class="small">${s.cliente} — ${s.producto} x ${s.cantidad} — ${formatMoney(s.total)} — ${s.metodo} — ${s.estado}</div>
          <div style="margin-top:6px">
            <button class="btn-inline view-btn" data-ref="${s.referencia}">Ver</button>
            <button class="btn-inline img-btn" data-ref="${s.referencia}">Imagen</button>
          </div>
        </div>`).join('');
      // attach events
      histList.querySelectorAll('.view-btn').forEach(b => {
        b.addEventListener('click', ()=> {
          const ref = b.dataset.ref;
          const s = loadSales().find(x=>x.referencia===ref);
          if(s) showReceiptPreview(s, {showShare:true, showImage:true});
        });
      });
      histList.querySelectorAll('.img-btn').forEach(b => {
        b.addEventListener('click', ()=> {
          const ref = b.dataset.ref;
          const s = loadSales().find(x=>x.referencia===ref);
          if(s){
            const tempNode = document.createElement('div');
            tempNode.className='receipt';
            tempNode.innerHTML = `
              <h2>UMM BOM DOLCE</h2>
              <p><strong>Referencia:</strong> ${s.referencia}</p>
              <p><strong>Fecha:</strong> ${s.fechaDisplay}</p>
              <hr>
              <p><strong>Cliente:</strong> ${s.cliente}</p>
              <p><strong>Producto:</strong> ${s.producto}</p>
              <p><strong>Cantidad:</strong> ${s.cantidad}</p>
              <p><strong>Valor unitario:</strong> ${formatMoney(s.valor)}</p>
              <p style="font-weight:700"><strong>Total: ${formatMoney(s.total)}</strong></p>
              <p style="text-align:center;margin-top:10px;">¡Gracias por su compra!</p>
            `;
            document.body.appendChild(tempNode);
            generateImageAndShare(s,tempNode).then(()=>{ document.body.removeChild(tempNode); });
          }
        });
      });
    }
    renderHist('');
    search.addEventListener('input', e => renderHist(e.target.value));
    document.getElementById('btnClearAll').addEventListener('click', ()=>{
      if(!confirm('¿Seguro que deseas eliminar todo el historial? Esta acción no se puede deshacer.')) return;
      localStorage.removeItem(SALES_KEY);
      previewEl.innerHTML = `<div class="receipt"><h2>Historial</h2><div class="small">Historial borrado</div></div>`;
    });
  });
  /* -----------------------------
     RESUMEN (totales + toggles cerrados por defecto)
     -----------------------------*/
  btnResumen.addEventListener('click', ()=>{
    const arr = loadSales();
    if(arr.length===0){ previewEl.innerHTML = `<div class="receipt"><h2>Resumen</h2><div class="small">No hay ventas registradas</div></div>`; return; }
    const pagadas = arr.filter(x=>x.estado==='Pagado');
    const fiadas = arr.filter(x=>x.estado==='Pendiente');
    const efectivo = pagadas.filter(x=>x.metodo==='Efectivo');
    const nequi = pagadas.filter(x=>x.metodo==='Nequi');
    const totalEfectivo = efectivo.reduce((s,x)=>s + x.total, 0);
    const totalNequi = nequi.reduce((s,x)=>s + x.total, 0);
    const totalFiado = fiadas.reduce((s,x)=>s + x.total, 0);
    const totalGeneral = totalEfectivo + totalNequi; // only paid
    let html = `<div class="receipt"><h2>Resumen de Ventas</h2>
      <p><strong>Total Efectivo:</strong> ${formatMoney(totalEfectivo)}</p>
      <p><strong>Total Nequi:</strong> ${formatMoney(totalNequi)}</p>
      <p><strong>Total Fiado:</strong> ${formatMoney(totalFiado)}</p>
      <p><strong>Total General (solo pagos):</strong> ${formatMoney(totalGeneral)}</p>
      <hr>
      <details><summary>Pagos Efectivo (${efectivo.length})</summary>
        ${efectivo.map(x=>`<div class="list-item">${x.referencia} — ${x.cliente} — ${x.producto} x ${x.cantidad} — ${formatMoney(x.total)}</div>`).join('') || '<div class="small">Sin registros</div>'}
      </details>
      <details><summary>Pagos Nequi (${nequi.length})</summary>
        ${nequi.map(x=>`<div class="list-item">${x.referencia} — ${x.cliente} — ${x.producto} x ${x.cantidad} — ${formatMoney(x.total)}</div>`).join('') || '<div class="small">Sin registros</div>'}
      </details>
      <details><summary>Fiadas / Pendientes (${fiadas.length})</summary>
        ${fiadas.map(x=>`<div class="list-item">${x.referencia} — ${x.cliente} — ${x.producto} x ${x.cantidad} — ${formatMoney(x.total)}</div>`).join('') || '<div class="small">Sin registros</div>'}
      </details>
      </div>`;
    previewEl.innerHTML = html;
    // details are closed by default (browser default behavior)
  });
  /* -----------------------------
     DEUDA (muestra pendientes con botones para marcar pagado)
     -----------------------------*/
  btnDeuda.addEventListener('click', ()=>{
    const arr = loadSales();
    const pendientes = arr.filter(x=>x.estado==='Pendiente');
    if(pendientes.length===0){ previewEl.innerHTML = `<div class="receipt"><h2>Deuda</h2><div class="small">No hay deudas pendientes</div></div>`; return; }
    const box = document.createElement('div');
    box.className = 'receipt';
    box.innerHTML = `<h2>Recibos Pendientes</h2>`;
    pendientes.forEach(p=>{
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <div><strong>${p.referencia}</strong> — ${p.fechaDisplay}</div>
        <div class="small">${p.cliente} — ${p.producto} x ${p.cantidad} — ${formatMoney(p.total)}</div>
        <div style="margin-top:6px">
          <button class="btn-inline" data-ref="${p.referencia}" data-method="Efectivo">Efectivo</button>
          <button class="btn-inline" data-ref="${p.referencia}" data-method="Nequi">Nequi</button>
          <button class="btn-inline view" data-ref="${p.referencia}">Ver</button>
        </div>
      `;
      box.appendChild(item);
    });
    previewEl.innerHTML = '';
    previewEl.appendChild(box);
    // attach events: mark paid
    box.querySelectorAll('button[data-method]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const ref = b.dataset.ref; const method = b.dataset.method;
        const sales = loadSales();
        const idx = sales.findIndex(s=>s.referencia===ref);
        if(idx===-1) return;
        sales[idx].estado = 'Pagado';
        sales[idx].metodo = method;
        saveSales(sales);
        alert(`Recibo ${ref} marcado como pagado (${method})`);
        // refresh view
        btnDeuda.click();
      });
    });
    // attach view buttons
    box.querySelectorAll('button.view').forEach(b=>{
      b.addEventListener('click', ()=>{
        const ref = b.dataset.ref;
        const sales = loadSales();
        const s = sales.find(x=>x.referencia===ref);
        if(s) showReceiptPreview(s,{showShare:false, showImage:false}); // remove share/image in debt preview
      });
    });
  });
  /* -----------------------------
     RECORDATORIO DE DEUDA
     -----------------------------*/
  btnRecordatorio.addEventListener('click', ()=>{
    const arr = loadSales();
    const pendientes = arr.filter(x=>x.estado==='Pendiente');
    if(pendientes.length===0){ previewEl.innerHTML = `<div class="receipt"><h2>Recordatorio de deuda</h2><div class="small">Sin pendientes</div></div>`; return; }
    const box = document.createElement('div'); box.className='receipt';
    box.innerHTML = `<h2>Recordatorio de Deudas</h2>`;
    pendientes.forEach(p=>{
      const itm = document.createElement('div'); itm.className='list-item';
      itm.innerHTML = `
        <div><strong>${p.referencia}</strong> — ${p.fechaDisplay}</div>
        <div class="small">${p.cliente} — ${p.producto} x ${p.cantidad} — ${formatMoney(p.total)}</div>
        <div style="margin-top:6px"><button class="btn-inline gen-img" data-ref="${p.referencia}">Generar imagen</button></div>
      `;
      box.appendChild(itm);
    });
    previewEl.innerHTML = '';
    previewEl.appendChild(box);
    // attach image generation
    box.querySelectorAll('.gen-img').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const ref = b.dataset.ref;
        const sale = loadSales().find(x=>x.referencia===ref);
        if(!sale) return;
        // create node with same receipt structure including day/date/time
        const node = document.createElement('div');
        node.className = 'receipt';
        node.style.fontFamily = 'Courier New, monospace';
        node.innerHTML = `
          <h2 style="font-family:Montserrat, sans-serif;margin:0 0 8px 0;text-align:center">UMM BOM DOLCE</h2>
          <p><strong>Referencia:</strong> ${sale.referencia}</p>
          <p><strong>Fecha:</strong> ${sale.fechaDisplay}</p>
          <hr>
          <p><strong>Cliente:</strong> ${sale.cliente}</p>
          <p><strong>Producto:</strong> ${sale.producto}</p>
          <p><strong>Cantidad:</strong> ${sale.cantidad}</p>
          <p><strong>Valor unitario:</strong> ${formatMoney(sale.valor)}</p>
          <p style="font-weight:700"><strong>Total pendiente: ${formatMoney(sale.total)}</strong></p>
          <p style="text-align:center;margin-top:8px"><strong>¡¡ RECORDATORIO DE DEUDA!!</strong></p>
        `;
        document.body.appendChild(node);
        const presetMessage = "Nequi: 3025656771 - Jeison Acuña";
        await generateImageAndShare(sale, node, presetMessage);
        document.body.removeChild(node);
      });
    });
  });
  /* -----------------------------
     init
     -----------------------------*/
  function init(){
    updateLiveTotal();
    if(!localStorage.getItem(SALES_KEY)) saveSales([]);
    if(!localStorage.getItem(COUNTER_KEY)) localStorage.setItem(COUNTER_KEY, '1');
  }
  init();
  </script>
  <!-- PWA: registrar service worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('✅ Service Worker registrado con éxito.'))
        .catch(error => console.error('❌ Error al registrar el Service Worker:', error));
    }
  </script>
</body>
</html>
